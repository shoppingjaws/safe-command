# safe-command ä»•æ§˜æ›¸

## æ¦‚è¦

**safe-command** ã¯ã€AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆClaude Codeç­‰ï¼‰ãŒå®Ÿè¡Œã§ãã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚’å®‰å…¨ã«åˆ¶é™ã™ã‚‹ãƒ—ãƒ­ã‚­ã‚·ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚

### èƒŒæ™¯

Claude Codeã§ã¯ã€`Bash(aws * get-:*)`ã®ã‚ˆã†ãªæŸ”è»Ÿãªãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã«ã‚ˆã‚‹ã‚³ãƒãƒ³ãƒ‰åˆ¶é™ãŒã§ãã¾ã›ã‚“ã€‚ãã“ã§ã€safe-commandã‚’ãƒ—ãƒ­ã‚­ã‚·ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹ã§ç‰¹å®šã®ã‚³ãƒãƒ³ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã¿ã‚’è¨±å¯ã™ã‚‹ä»•çµ„ã¿ã‚’æä¾›ã—ã¾ã™ã€‚

### ç›®çš„

- AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ã‚ˆã‚‹å±é™ºãªã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã‚’é˜²ã
- èª­ã¿å–ã‚Šå°‚ç”¨ã‚³ãƒãƒ³ãƒ‰ã‚„å®‰å…¨ãªã‚³ãƒãƒ³ãƒ‰ã®ã¿ã‚’è¨±å¯
- è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§æŸ”è»Ÿã«ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®šç¾©å¯èƒ½

## Phase 1: åˆæœŸå®Ÿè£…

Phase 1ã§ã¯ã€ä»¥ä¸‹ã®æ©Ÿèƒ½ã«é›†ä¸­ã—ã¾ã™ï¼š

- âœ… AWSã‚³ãƒãƒ³ãƒ‰ã®ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰ãƒ¬ãƒ™ãƒ«ã§ã®è¨±å¯/æ‹’å¦
- âœ… è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆYAMLï¼‰ã«ã‚ˆã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³å®šç¾©
- âœ… åŸºæœ¬çš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯
- âœ… å®Ÿã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œã¨ãƒ—ãƒ­ã‚­ã‚·æ©Ÿèƒ½

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Claude Code â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ safe-command -- aws s3 ls
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    safe-command (Proxy)    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 1. Parse Arguments   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚             â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 2. Load Config       â”‚  â”‚
â”‚  â”‚    (config.yaml)â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚             â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 3. Pattern Match     â”‚  â”‚
â”‚  â”‚    (aws.ts)          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚             â–¼              â”‚
â”‚        Allowed? â”€â”€â”€Noâ”€â”€â–¶ Error
â”‚             â”‚Yes           â”‚
â”‚             â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 4. Execute Command   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚  AWS CLI    â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä»•æ§˜

### è¨­è¨ˆæ–¹é‡

safe-commandã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€ä»¥ä¸‹ã®åŸå‰‡ã«åŸºã¥ã„ã¦è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ï¼š

1. **ã‚·ãƒ³ãƒ—ãƒ«ç¬¬ä¸€**: æ–‡å­—åˆ—é…åˆ—ã«ã‚ˆã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³å®šç¾©ã§ã€å­¦ç¿’ã‚³ã‚¹ãƒˆã‚’æœ€å°é™ã«
2. **ã‚»ã‚­ãƒ¥ã‚¢ãƒã‚¤ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ**: æ˜ç¤ºçš„ã«è¨±å¯ã•ã‚ŒãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã¿å®Ÿè¡Œå¯èƒ½ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ‹’å¦ï¼‰
3. **å¯èª­æ€§é‡è¦–**: YAMLã‚³ãƒ¡ãƒ³ãƒˆã‚’æ´»ç”¨ã—ã¦ã€ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ„å›³ã‚’æ˜ç¢ºã«
4. **æ‹¡å¼µæ€§ã®ä¿æŒ**: å°†æ¥çš„ãªæ©Ÿèƒ½è¿½åŠ ã«å¯¾å¿œã§ãã‚‹æ§‹é€ 

### ãƒ•ã‚¡ã‚¤ãƒ«å

`config.yaml` (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã¾ãŸã¯`~/.config/safe-command/config.yaml`)

### ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

```yaml
# safe-command è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: å…¨ã¦ã®ã‚³ãƒãƒ³ãƒ‰ã¯æ‹’å¦ã•ã‚Œã‚‹
# patterns ã«æ˜ç¤ºçš„ã«è¨˜è¼‰ã•ã‚ŒãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã¿è¨±å¯ã•ã‚Œã‚‹

commands:
  aws:
    patterns:
      # ============================================
      # Read-only operations (æ¨å¥¨: AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‘ã‘)
      # ============================================

      # æ±ç”¨çš„ãªèª­ã¿å–ã‚Šã‚³ãƒãƒ³ãƒ‰
      - "* list-*"      # ä»»æ„ã®ã‚µãƒ¼ãƒ“ã‚¹ã® list- ã‚³ãƒãƒ³ãƒ‰
      - "* get-*"       # ä»»æ„ã®ã‚µãƒ¼ãƒ“ã‚¹ã® get- ã‚³ãƒãƒ³ãƒ‰
      - "* describe-*"  # ä»»æ„ã®ã‚µãƒ¼ãƒ“ã‚¹ã® describe- ã‚³ãƒãƒ³ãƒ‰

      # S3 èª­ã¿å–ã‚Šæ“ä½œ
      - "s3 ls*"        # ãƒã‚±ãƒƒãƒˆ/ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§

      # Identity ç¢ºèª
      - "sts get-caller-identity"  # ç¾åœ¨ã®IAMãƒ¦ãƒ¼ã‚¶ãƒ¼/ãƒ­ãƒ¼ãƒ«ç¢ºèª

      # ============================================
      # æ³¨æ„: ä»¥ä¸‹ã¯æ›¸ãè¾¼ã¿æ“ä½œã®ãŸã‚ã€é€šå¸¸ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆæ¨å¥¨
      # ============================================
      # - "s3 cp*"      # S3ã¸ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚³ãƒ”ãƒ¼
      # - "s3 rm*"      # S3ã‹ã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
      # - "ec2 run-instances*"  # EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹•
```

### ã‚¹ã‚­ãƒ¼ãƒå®šç¾©

```typescript
type SafeCommandConfig = {
  commands: {
    [commandName: string]: {
      patterns: string[];
    };
  };
};
```

## CLIã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

### åŸºæœ¬çš„ãªä½¿ç”¨æ–¹æ³•

```bash
# ä½¿ç”¨æ–¹æ³•
safe-command [options] -- <command> [args...]

# ä¾‹
safe-command -- aws s3 ls
safe-command -- aws ec2 describe-instances
safe-command -- aws sts get-caller-identity

# safe-commandè‡ªä½“ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚‚ä½¿ç”¨å¯èƒ½ï¼ˆå°†æ¥çš„ã«ï¼‰
# safe-command --dry-run -- aws s3 rm s3://bucket/file.txt
```

### å®Ÿè¡Œçµæœ

#### è¨±å¯ã•ã‚ŒãŸå ´åˆ

å®Ÿã‚³ãƒãƒ³ãƒ‰ã®æ¨™æº–å‡ºåŠ›/æ¨™æº–ã‚¨ãƒ©ãƒ¼ã‚’ãã®ã¾ã¾è¿”ã—ã¾ã™ã€‚çµ‚äº†ã‚³ãƒ¼ãƒ‰ã‚‚å®Ÿã‚³ãƒãƒ³ãƒ‰ã®çµ‚äº†ã‚³ãƒ¼ãƒ‰ã‚’ãã®ã¾ã¾è¿”ã—ã¾ã™ã€‚

```bash
$ safe-command -- aws s3 ls
2024-01-01 12:00:00 my-bucket-1
2024-01-01 12:00:00 my-bucket-2
```

#### æ‹’å¦ã•ã‚ŒãŸå ´åˆ

ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¨™æº–ã‚¨ãƒ©ãƒ¼ã«å‡ºåŠ›ã—ã€çµ‚äº†ã‚³ãƒ¼ãƒ‰1ã§çµ‚äº†ã—ã¾ã™ã€‚

```bash
$ safe-command -- aws s3 rm s3://my-bucket/file.txt
Error: Command not allowed: aws s3 rm s3://my-bucket/file.txt
No matching pattern found in config.yaml
```

## ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ä»•æ§˜

### ãƒãƒƒãƒãƒ³ã‚°ãƒ«ãƒ¼ãƒ«

1. **å®Œå…¨ä¸€è‡´**: ãƒ‘ã‚¿ãƒ¼ãƒ³ã«`*`ãŒå«ã¾ã‚Œãªã„å ´åˆã€å¼•æ•°ãŒå®Œå…¨ã«ä¸€è‡´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
2. **ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰**: `*`ã¯0æ–‡å­—ä»¥ä¸Šã®ä»»æ„ã®æ–‡å­—åˆ—ã«ãƒãƒƒãƒã—ã¾ã™
3. **ORæ¡ä»¶**: è¤‡æ•°ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã„ãšã‚Œã‹ã«ãƒãƒƒãƒã™ã‚Œã°è¨±å¯ã•ã‚Œã¾ã™
4. **å¤§æ–‡å­—å°æ–‡å­—**: åŒºåˆ¥ã•ã‚Œã¾ã™ï¼ˆAWSã‚³ãƒãƒ³ãƒ‰ã¯ã‚±ãƒ¼ã‚¹ã‚»ãƒ³ã‚·ãƒ†ã‚£ãƒ–ãªãŸã‚ï¼‰

### ãƒãƒƒãƒãƒ³ã‚°ä¾‹

è¨­å®š:
```yaml
commands:
  aws:
    patterns:
      - "s3 ls*"
      - "ec2 describe-instances"
```

| ã‚³ãƒãƒ³ãƒ‰ | ãƒãƒƒãƒ | ç†ç”± |
|---------|--------|------|
| `aws s3 ls` | âœ… | `s3 ls*`ã«ãƒãƒƒãƒ |
| `aws s3 ls s3://bucket` | âœ… | `s3 ls*`ã«ãƒãƒƒãƒ |
| `aws s3 cp` | âŒ | ã©ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚‚ãƒãƒƒãƒã—ãªã„ |
| `aws ec2 describe-instances` | âœ… | å®Œå…¨ä¸€è‡´ |
| `aws ec2 describe-instances --region us-east-1` | âŒ | å®Œå…¨ä¸€è‡´ã›ãš |

### ãƒ‘ã‚¿ãƒ¼ãƒ³è¨­è¨ˆã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

```yaml
commands:
  aws:
    patterns:
      # ğŸ‘ æ¨å¥¨: èª­ã¿å–ã‚Šå°‚ç”¨ã‚³ãƒãƒ³ãƒ‰ã‚’è¨±å¯
      - "* list-*"
      - "* get-*"
      - "* describe-*"
      - "sts get-caller-identity"

      # âš ï¸ æ³¨æ„ãŒå¿…è¦: æ›¸ãè¾¼ã¿ã‚³ãƒãƒ³ãƒ‰ã¯æ…é‡ã«
      # - "s3 cp*"
      # - "ec2 run-instances*"

      # ğŸš« éæ¨å¥¨: åºƒç¯„ã™ãã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³
      # - "*"  # å…¨ã¦ã®ã‚³ãƒãƒ³ãƒ‰ã‚’è¨±å¯ã—ã¦ã—ã¾ã†
```

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 

```
safe-command/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts        # ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã€CLIå¼•æ•°è§£æ
â”‚   â”œâ”€â”€ config.ts       # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
â”‚   â”œâ”€â”€ matcher.ts      # æ±ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯
â”‚   â”œâ”€â”€ executor.ts     # ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
â”‚   â””â”€â”€ aws.ts          # AWSå›ºæœ‰ã®ãƒ­ã‚¸ãƒƒã‚¯ãƒ»ãƒ‘ã‚¿ãƒ¼ãƒ³å®šç¾©
â”œâ”€â”€ examples/
â”‚   â””â”€â”€ config.yaml  # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä¾‹
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ matcher.test.ts
â”‚   â”œâ”€â”€ aws.test.ts
â”‚   â””â”€â”€ integration.test.ts
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ SPEC.md            # ã“ã®ä»•æ§˜æ›¸
â””â”€â”€ README.md          # ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
```

### å„ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¹å‰²

#### `src/index.ts`

- CLIã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
- ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã®è§£æ
- å…¨ä½“ã®ãƒ•ãƒ­ãƒ¼åˆ¶å¾¡

```typescript
// æ“¬ä¼¼ã‚³ãƒ¼ãƒ‰
const args = process.argv.slice(2);

// "--" ã‚’æ¢ã—ã¦ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ã‚³ãƒãƒ³ãƒ‰ã‚’åˆ†é›¢
const delimiterIndex = args.indexOf('--');
if (delimiterIndex === -1) {
  console.error('Error: Missing "--" delimiter');
  process.exit(1);
}

const options = args.slice(0, delimiterIndex);
const [command, ...commandArgs] = args.slice(delimiterIndex + 1);

const config = await loadConfig();
const allowed = await checkAllowed(command, commandArgs, config);

if (allowed) {
  await executeCommand(command, commandArgs);
} else {
  console.error(`Error: Command not allowed: ${command} ${commandArgs.join(' ')}`);
  process.exit(1);
}
```

#### `src/config.ts`

- è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
- è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã®å‡¦ç†

#### `src/matcher.ts`

- æ±ç”¨çš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯
- ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã®å‡¦ç†
- ä»–ã®ã‚³ãƒãƒ³ãƒ‰ï¼ˆå°†æ¥çš„ã«kubectlç­‰ï¼‰ã§ã‚‚å†åˆ©ç”¨å¯èƒ½

```typescript
export function matchPattern(pattern: string, target: string): boolean {
  // ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã‚’æ­£è¦è¡¨ç¾ã«å¤‰æ›ã—ã¦ãƒãƒƒãƒãƒ³ã‚°
}
```

#### `src/executor.ts`

- å®Ÿã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œ
- æ¨™æº–å‡ºåŠ›/æ¨™æº–ã‚¨ãƒ©ãƒ¼ã®å‡¦ç†
- çµ‚äº†ã‚³ãƒ¼ãƒ‰ã®å‡¦ç†

```typescript
export async function executeCommand(
  command: string,
  args: string[]
): Promise<void> {
  // Bun.spawnã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
}
```

#### `src/aws.ts`

- AWSã‚³ãƒãƒ³ãƒ‰å›ºæœ‰ã®ãƒ­ã‚¸ãƒƒã‚¯
- AWS CLIã®ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰æ§‹é€ ã®è§£æ
- å°†æ¥çš„ã«AWSå›ºæœ‰ã®å‰å‡¦ç†ãƒ»å¾Œå‡¦ç†ã‚’è¿½åŠ ã™ã‚‹éš›ã®æ‹¡å¼µãƒã‚¤ãƒ³ãƒˆ

```typescript
export function parseAwsCommand(args: string[]): string {
  // aws s3 ls s3://bucket â†’ "s3 ls s3://bucket"
  return args.join(' ');
}
```

## æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

### ãƒ©ãƒ³ã‚¿ã‚¤ãƒ 

- **Bun**: é«˜é€ŸãªJavaScript/TypeScriptãƒ©ãƒ³ã‚¿ã‚¤ãƒ 
  - ç†ç”±: é«˜é€Ÿãªèµ·å‹•ã€TypeScriptãƒã‚¤ãƒ†ã‚£ãƒ–ã‚µãƒãƒ¼ãƒˆã€å„ªã‚ŒãŸé–‹ç™ºä½“é¨“

### è¨€èª

- **TypeScript**: å‹å®‰å…¨æ€§ã¨ã‚³ãƒ¼ãƒ‰å“è³ªã®å‘ä¸Š

### ä¾å­˜é–¢ä¿‚

- **js-yaml** ã¾ãŸã¯ Bunæ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒª: YAMLè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
- **Bun.spawn**: ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ

### é–‹ç™ºãƒ„ãƒ¼ãƒ«

- **Bun test**: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
- **TypeScript**: å‹ãƒã‚§ãƒƒã‚¯

## å®Ÿè£…ãƒ•ãƒ­ãƒ¼

### 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
bun init
```

### 2. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿

1. `./config.yaml`ã‚’æ¢ã™
2. ãªã‘ã‚Œã°`~/.config/safe-command/config.yaml`ã‚’æ¢ã™
3. ã©ã¡ã‚‰ã‚‚ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼

### 3. ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°

```typescript
function isAllowed(command: string, args: string[], config: SafeCommandConfig): boolean {
  const commandConfig = config.commands[command];
  if (!commandConfig) return false;

  const argsString = args.join(' ');

  for (const pattern of commandConfig.patterns) {
    if (matchPattern(pattern, argsString)) {
      return true;
    }
  }

  return false;
}
```

### 4. ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ

```typescript
async function executeCommand(command: string, args: string[]): Promise<void> {
  const proc = Bun.spawn([command, ...args], {
    stdout: 'inherit',
    stderr: 'inherit',
  });

  const exitCode = await proc.exited;
  process.exit(exitCode);
}
```

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„

```
Error: Configuration file not found
Searched locations:
  - ./config.yaml
  - ~/.config/safe-command/config.yaml

Please create a configuration file. See examples/ for sample configuration.
```

### ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ãƒãƒƒãƒã—ãªã„

```
Error: Command not allowed: aws s3 rm s3://my-bucket/file.txt
No matching pattern found in config.yaml

To allow this command, add a pattern like:
  commands:
    aws:
      patterns:
        - "s3 rm*"
```

### å®Ÿã‚³ãƒãƒ³ãƒ‰ãŒå­˜åœ¨ã—ãªã„

å®Ÿã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œã‚¨ãƒ©ãƒ¼ã‚’ãã®ã¾ã¾è¿”ã—ã¾ã™ã€‚

```
Error: command not found: aws
```

### YAMLæ§‹æ–‡ã‚¨ãƒ©ãƒ¼

```
Error: Failed to parse config.yaml
Syntax error at line 5: unexpected token

Please check your YAML syntax.
```

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### å®‰å…¨ãªãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ

- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯**ä½•ã‚‚è¨±å¯ã—ãªã„**
- è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§æ˜ç¤ºçš„ã«è¨±å¯ã•ã‚ŒãŸã‚³ãƒãƒ³ãƒ‰ã®ã¿å®Ÿè¡Œå¯èƒ½

### ãƒ‘ã‚¿ãƒ¼ãƒ³è¨­è¨ˆã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

1. **æœ€å°æ¨©é™ã®åŸå‰‡**: å¿…è¦æœ€å°é™ã®ã‚³ãƒãƒ³ãƒ‰ã®ã¿è¨±å¯
2. **èª­ã¿å–ã‚Šå°‚ç”¨ã‚’å„ªå…ˆ**: `list-`, `get-`, `describe-`ãªã©ã®èª­ã¿å–ã‚Šã‚³ãƒãƒ³ãƒ‰ã‚’å„ªå…ˆ
3. **ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã®æ³¨æ„**: `*`å˜ä½“ã¯é¿ã‘ã€å…·ä½“çš„ãªãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’æŒ‡å®š

### ç’°å¢ƒå¤‰æ•°

- `AWS_ACCESS_KEY_ID`ç­‰ã®ç’°å¢ƒå¤‰æ•°ã¯ãã®ã¾ã¾å®Ÿã‚³ãƒãƒ³ãƒ‰ã«æ¸¡ã•ã‚Œã‚‹
- æ©Ÿå¯†æƒ…å ±ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã¯Phase 2ã§æ¤œè¨

## å°†æ¥ã®æ‹¡å¼µæ€§ï¼ˆPhase 2ä»¥é™ï¼‰

Phase 1å®Ÿè£…å¾Œã«æ¤œè¨ã™ã‚‹æ©Ÿèƒ½ï¼š

### ä»–ã®ã‚³ãƒãƒ³ãƒ‰å¯¾å¿œ

```typescript
// src/kubectl.ts
// src/terraform.ts
```

```yaml
commands:
  kubectl:
    patterns:
      - "get *"
      - "describe *"
  terraform:
    patterns:
      - "plan*"
      - "show*"
```

### ãƒ­ã‚°ãƒ»ç›£æŸ»æ©Ÿèƒ½

```yaml
logging:
  enabled: true
  file: ~/.config/safe-command/audit.log
```

### Dry-runæ©Ÿèƒ½

```bash
safe-command --dry-run -- aws s3 rm s3://bucket/file.txt
# Would execute: aws s3 rm s3://bucket/file.txt
# Result: DENIED (no matching pattern)
```

### ç’°å¢ƒå¤‰æ•°ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°

```yaml
commands:
  aws:
    patterns:
      - "s3 ls*"
    env_allow:
      - AWS_PROFILE
      - AWS_REGION
    env_deny:
      - AWS_SECRET_ACCESS_KEY  # æ©Ÿå¯†æƒ…å ±ã‚’éš ã™
```

### ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ¢ãƒ¼ãƒ‰

```bash
safe-command -- aws s3 rm s3://bucket/file.txt
# Command not allowed: aws s3 rm s3://bucket/file.txt
# Do you want to add this pattern to config.yaml? [y/N]
```

## ã¾ã¨ã‚

safe-commandã¯ã€AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå®Ÿè¡Œã§ãã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚’å®‰å…¨ã«åˆ¶é™ã™ã‚‹ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ—ãƒ­ã‚­ã‚·ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚Phase 1ã§ã¯ã€AWS CLIã‚³ãƒãƒ³ãƒ‰ã®åŸºæœ¬çš„ãªè¨±å¯/æ‹’å¦æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹ã§æŸ”è»Ÿã«ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®šç¾©ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

å°†æ¥çš„ã«ã¯ã€ä»–ã®ã‚³ãƒãƒ³ãƒ‰ã¸ã®å¯¾å¿œã‚„ãƒ­ã‚°æ©Ÿèƒ½ãªã©ã€ã‚ˆã‚Šé«˜åº¦ãªæ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¦ã„ãäºˆå®šã§ã™ã€‚
